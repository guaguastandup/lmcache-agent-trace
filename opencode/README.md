# OpenCode Trace Analysis & Prefix Caching Case Study

This document analyzes the execution traces generated by [OpenCode](https://github.com/anomalyco/opencode) running on coding tasks. It integrates architectural analysis with code-level evidence to explain the high effectiveness of KV Cache reuse.

---

## 1. Background: Cache Types

* **Prefix Match**
* Matches that are identical starting from the very beginning of the prompt (index 0). Even a single different token breaks the chain for all subsequent content.

* **Substring Match**
* Repeated text blocks located in the middle or end of the prompt, where the preceding content has changed.

---

## 2. Architecture Insight: Linear Feedback Loop

OpenCode utilizes a **Linear Append Architecture**. It treats the coding process as a sequential dialogue where execution results and new instructions are strictly appended to the end of the history.

### The Append-Only Strategy

Unlike agents that inject context into the middle of the prompt (which breaks the prefix), OpenCode appends **Tool Results** (file contents, execution logs) to the end.

> **Analysis**: Since existing blocks are never shifted or modified, the **KV Cache Prefix** remains valid for the entire duration of the session.

---

## 3. Technical Implementation: Prompt Assembly

The code analysis of `src/session/prompt/` confirms the architectural findings. The final prompt sent to the LLM is constructed in strictly defined blocks.

### Structure of the Final Prompt

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        System Prompt (Static Base)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. System                                                   â”‚   â”‚
â”‚  â”‚    "You are OpenCode, the best coding agent..."             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ 2. Environment                                              â”‚   â”‚
â”‚  â”‚    <env> Working directory, Platform, Date... </env>        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       Messages (Linear History)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ User: "Fix the login bug"                                   â”‚   â”‚
â”‚  â”‚ Assistant: [Tool Call] Read(file="src/auth.ts")             â”‚   â”‚
â”‚  â”‚ Tool: [File Content] ...                                    â”‚   â”‚
â”‚  â”‚ Assistant: [Tool Call] Edit(...)                            â”‚   â”‚
â”‚  â”‚ Tool: Success                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              ...                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Current Turn (New Input)                    â”‚
â”‚  User: "Great, now optimize it."                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Performance Data Analysis

We analyzed the trace `gpt-5-mini-task2` to evaluate the actual cache behavior based on the implementation above.

<div align=center> <img src="./images/gpt-5-mini-task2.png" width="1000"/> </div>

### High Overlap Between Prefix and Substring

The most notable observation from the chart is the **extreme proximity** of the two curves.

* **Prefix Matching (Teal)**: ~86.1%
* **Substring Matching (Purple)**: ~89.0%

**Interpretation**:
The gap between the two is less than 3%. This indicates a **high degree of overlap**. Almost all reusable content in OpenCode is located at the prefix.

Unlike other architectures where "hidden" reusable blocks appear in the middle of the prompt (creating a large gap between Prefix and Substring), OpenCode's linear structure means that **if it's cached, it's almost certainly a Prefix Cache hit.** The remaining ~2.9% gain likely comes from repeated boilerplate code or identical error logs appearing in non-consecutive turns.

---

## 5. Visualization & Execution

We provide a dedicated visualizer to explore these traces interactively and a repository to reproduce the results.

### ğŸ›  Visualization Tool

You can load raw `.jsonl` trace files to inspect token distribution and cache hits.

* **Online Visualizer**: [https://lmcache-aider-trace.netlify.app/](https://lmcache-aider-trace.netlify.app/)
* **Offline Visualizer**: [visualizer](https://www.google.com/search?q=../visualizer/index.html)

### ğŸš€ Setup & Execution

For reproduction and detailed patch information regarding the OpenCode trace generation:

* **Repository**: [https://github.com/guaguastandup/opencode-trace-patch](https://github.com/guaguastandup/opencode-trace-patch)
* **Instruction**: Please refer to the README.md in that repository for detailed configuration and execution steps.